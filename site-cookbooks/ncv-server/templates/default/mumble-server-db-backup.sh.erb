#!/bin/bash -e

source_path="<%= node[:murmur][:config][:database] %>"
timestamp=$( date +%Y%m%d%H%M%S )
keep_count=7

source_dir=$( dirname "$source_path" )
source_file=$( basename "$source_path" )

backup_dir="$source_dir/backups"
source_ext="${source_file##*.}"
source_file_root="${source_file%.*}"

backup_file="$source_file"
rotate_glob="$backup_dir/${source_file_root}.*.${source_ext}.gz"
rotate_file="${source_file_root}.${timestamp}.${source_ext}"

backup_path="$backup_dir/$backup_file"
rotate_path="$backup_dir/$rotate_file"

function create_backup {
  cp "$source_path" "$backup_path"
  cp "$backup_path" "$rotate_path"
  gzip "$rotate_path"
}

function prune_backups {
  backup_count=$( ls -1f $rotate_glob | wc -l | xargs echo )
  while [ $backup_count -gt $keep_count ]; do
    rm "$( ls -1t $rotate_glob | tail -n1 )"
    let backup_count=$( ls -1f $rotate_glob | wc -l | xargs echo )
  done
}

mkdir -p "$backup_dir"
create_backup
prune_backups
